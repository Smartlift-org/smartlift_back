#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# If we're starting the Rails server, run database setup first
if [[ "$1" == "bundle" && "$2" == "exec" && "$3" == "puma" ]]; then
    echo "ğŸš€ Starting Rails application setup..."
    
    # Wait for database to be ready
    echo "â³ Waiting for database connection..."
    bundle exec rails runner "ActiveRecord::Base.connection.execute('SELECT 1')"
    echo "âœ… Database connection established"
    
    # Run database migrations
    echo "ğŸ“Š Running database migrations..."
    bundle exec rails db:migrate
    echo "âœ… Database migrations completed"
    
    # Import exercises
    echo "ğŸ‹ï¸ Importing exercises..."
    bundle exec rails exercises:import
    echo "âœ… Exercise import completed"
    
    # Seed database
    echo "ğŸŒ± Seeding database..."
    bundle exec rails db:seed
    echo "âœ… Database seeding completed"
    
    echo "ğŸ‰ Rails application setup completed successfully!"
fi

# Execute the main command
exec "${@}"
