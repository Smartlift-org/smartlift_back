#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# If we're starting the Rails server, run database setup first
if [[ "$1" == "bundle" && "$2" == "exec" && "$3" == "puma" ]]; then
    echo "🚀 Starting Rails application setup..."
    
    # Wait for database to be ready
    echo "⏳ Waiting for database connection..."
    bundle exec rails runner "ActiveRecord::Base.connection.execute('SELECT 1')"
    echo "✅ Database connection established"
    
    # Run database migrations
    echo "📊 Running database migrations..."
    bundle exec rails db:migrate
    echo "✅ Database migrations completed"
    
    # Import exercises
    echo "🏋️ Importing exercises..."
    bundle exec rails exercises:import
    echo "✅ Exercise import completed"
    
    # Seed database
    echo "🌱 Seeding database..."
    bundle exec rails db:seed
    echo "✅ Database seeding completed"
    
    echo "🎉 Rails application setup completed successfully!"
fi

# Execute the main command
exec "${@}"
